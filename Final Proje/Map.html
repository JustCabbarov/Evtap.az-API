<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xəritədə Elanlar</title>

  <!-- Leaflet kitabxanası -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    #map {
      width: 100%;
      height: 100vh;
    }
.custom-marker {
  background-color: rgba(0, 51, 153, 0.9); /* Tünd mavi */
  border: 2px solid #fff;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  transition: transform 0.2s ease, background-color 0.2s ease;
  box-shadow: 0 0 6px rgba(0, 51, 153, 0.7);
}

.custom-marker:hover {
  background-color: rgba(0, 102, 255, 1); /* Hover zamanı bir az açıq mavi */
  transform: scale(1.3);
  box-shadow: 0 0 10px rgba(0, 102, 255, 0.9);
}


    /* Hover popup (baloncuk) */
    .hover-popup {
      position: absolute;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 8px;
      width: 200px;
      z-index: 9999;
      transition: opacity 0.2s ease;
    }

    .hover-popup img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }

    .hover-popup h4 {
      font-size: 15px;
      margin: 5px 0;
      color: #222;
    }

    .hover-popup p {
      margin: 0;
      color: #007bff;
      font-weight: bold;
    }
.marker-cluster-small,
.marker-cluster-medium,
.marker-cluster-large {
  background-color: rgba(0, 51, 153, 0.85);
  color: white;
  border-radius: 50%;
  border: 2px solid white;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet və MarkerCluster kitabxanaları -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    const API_URL = "https://localhost:7027/api/Listing/GetListingsDetail";
    const map = L.map("map").setView([40.4093, 49.8671], 12);

    // Xəritə layı
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const markers = L.markerClusterGroup();

    // Custom marker (dairə)
    const createCustomIcon = () => {
      return L.divIcon({
        className: "custom-marker",
        iconSize: [22, 22],
      });
    };

    // Hover popup yarat
    function createHoverPopup(item, latlng) {
      const popup = document.createElement("div");
      popup.className = "hover-popup";
      popup.innerHTML = `
        <img src="${item.images?.[0] || ''}" alt="Image">
        <h4>${item.title}</h4>
        <p>${item.price} ₼</p>
      `;
      document.body.appendChild(popup);

      const point = map.latLngToContainerPoint(latlng);
      popup.style.left = `${point.x + 15}px`;
      popup.style.top = `${point.y - 60}px`;

      return popup;
    }

    async function loadListings() {
      try {
        const res = await fetch(API_URL);
        const listings = await res.json();

        listings.forEach((item) => {
          if (item.location?.latitude && item.location?.longitude) {
            const marker = L.marker(
              [item.location.latitude, item.location.longitude],
              { icon: createCustomIcon() }
            );

            let hoverPopup = null;

            marker.on("mouseover", (e) => {
              hoverPopup = createHoverPopup(item, e.latlng);
            });

            marker.on("mouseout", () => {
              if (hoverPopup) {
                hoverPopup.remove();
                hoverPopup = null;
              }
            });

            marker.on("click", () => {
              window.location.href = `http://127.0.0.1:5501/property.html?id=${item.id}`;
            });

            markers.addLayer(marker);
          }
        });

        map.addLayer(markers);
      } catch (error) {
        console.error("Error loading listings:", error);
      }
    }

    loadListings();

    // Xəritə hərəkət edəndə hover-popup-ları təmizlə
    map.on("movestart", () => {
      document.querySelectorAll(".hover-popup").forEach(el => el.remove());
    });
  </script>
</body>
</html>
